[build]
  base      = "."
  command   = "npm install && npm --prefix apps/web install && npm --prefix apps/web run build"
  publish   = "apps/web/.next"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  # Set in Netlify UI: JWT_SECRET, DATABASE_URL, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET
  # Email: SENDGRID_API_KEY, SENDGRID_FROM or AWS SES keys
  # Rate limiting: RATE_LIMIT_SECRET, AI_RATE_LIMIT_PER_MINUTE
  # OAuth: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET
  # Auth: NEXTAUTH_SECRET

# =============================================================================
# Production Context (main/master branch)
# =============================================================================
[context.production]
  base    = "."
  command = "npm install && npm --prefix apps/web install && npm --prefix apps/web run build"

[context.production.environment]
  NEXT_PUBLIC_API_URL = "https://ngurra-api-production.up.railway.app"
  NEXT_PUBLIC_SOCKET_URL = "https://ngurra-api-production.up.railway.app"
  NEXTAUTH_URL = "https://ngurrapathways.life"
  NODE_ENV = "production"

# =============================================================================
# Staging Context (staging branch)
# =============================================================================
[context.staging]
  base    = "."
  command = "npm install && npm --prefix apps/web install && npm --prefix apps/web run build"

[context.staging.environment]
  NEXT_PUBLIC_API_URL = "https://api-staging.gimbi.com.au"
  NEXT_PUBLIC_SOCKET_URL = "https://api-staging.gimbi.com.au"
  NEXTAUTH_URL = "https://staging.ngurrapathways.life"
  NODE_ENV = "staging"

# =============================================================================
# Deploy Preview Context (PR branches)
# =============================================================================
[context.deploy-preview]
  base    = "."
  command = "npm install && npm --prefix apps/web install && npm --prefix apps/web run build"

[context.deploy-preview.environment]
  NEXT_PUBLIC_API_URL = "https://api-staging.gimbi.com.au"
  NEXT_PUBLIC_SOCKET_URL = "https://api-staging.gimbi.com.au"
  NEXTAUTH_URL = "https://deploy-preview-<id>--ngurrapathways.netlify.app"
  NODE_ENV = "preview"

# =============================================================================
# Branch Deploy Context (feature branches)
# =============================================================================
[context.branch-deploy]
  base    = "."
  command = "npm install && npm --prefix apps/web install && npm --prefix apps/web run build"

[context.branch-deploy.environment]
  NEXT_PUBLIC_API_URL = "https://api-staging.gimbi.com.au"
  NEXT_PUBLIC_SOCKET_URL = "https://api-staging.gimbi.com.au"
  NEXTAUTH_URL = "https://branch-<name>--ngurrapathways.netlify.app"
  NODE_ENV = "preview"

# =============================================================================
# Development
# =============================================================================
[dev]
  command   = "npm run dev --prefix apps/web"
  functions = "netlify/functions"
  port      = 8888
  autoLaunch = false

# =============================================================================
# Plugins
# =============================================================================
[[plugins]]
  package = "@netlify/plugin-nextjs"

# Note: netlify-plugin-cache removed - Next.js plugin handles caching automatically

# =============================================================================
# Headers for Security
# =============================================================================
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(self), microphone=(self), geolocation=()"

# Static assets caching
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/brand/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800"

[[headers]]
  for = "/api/*"
  [headers.values]
    # SECURITY: Restrict CORS to specific trusted domains (do not use wildcard "*")
    Access-Control-Allow-Origin = "https://ngurrapathways.life"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Authorization, Content-Type"
    Access-Control-Allow-Credentials = "true"

# =============================================================================
# Redirects
# =============================================================================
# API Proxy - Route all /api/* requests to Railway backend
[[redirects]]
  from = "/api/*"
  to = "https://ngurra-api-production.up.railway.app/:splat"
  status = 200
  force = true
  headers = {X-From = "Netlify"}

# Health check endpoints
[[redirects]]
  from = "/health"
  to = "/.netlify/functions/health"
  status = 200

# WWW to non-WWW redirect
[[redirects]]
  from = "https://www.ngurrapathways.life/*"
  to = "https://ngurrapathways.life/:splat"
  status = 301
  force = true
