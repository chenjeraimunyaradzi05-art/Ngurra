name: Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly security scans
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run npm audit (API)
        working-directory: apps/api
        run: npm audit --audit-level=high || true
        continue-on-error: true
        
      - name: Run npm audit (Web)
        working-directory: apps/web
        run: npm audit --audit-level=high || true
        continue-on-error: true
        
      - name: Check for known vulnerabilities
        run: |
          echo "Checking for critical vulnerabilities..."
          npm audit --json 2>/dev/null | jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical"))' || echo "No critical issues found"

  code-security-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Run custom security audit
        run: node tools/security-audit.js
        continue-on-error: true
        
      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          # Simple grep for common secret patterns (informational only)
          grep -rn --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            -E "(password|secret|api_key|apikey).*=.*['\"][^'\"]{10,}['\"]" \
            apps/ netlify/ 2>/dev/null || echo "No hardcoded secrets detected"
            
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Check licenses (API)
        working-directory: apps/api
        run: |
          npx license-checker --summary --failOn "GPL-3.0;AGPL-3.0" 2>/dev/null || \
          echo "License check completed (some packages may not have explicit licenses)"
        continue-on-error: true

  security-headers-check:
    name: Security Headers Check
    runs-on: ubuntu-latest
    needs: [dependency-audit]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check security headers configuration
        run: |
          echo "Verifying security headers in next.config.js..."
          grep -q "Strict-Transport-Security" apps/web/next.config.js && echo "✓ HSTS configured" || echo "✗ HSTS missing"
          grep -q "Content-Security-Policy" apps/web/next.config.js && echo "✓ CSP configured" || echo "✗ CSP missing"
          grep -q "X-Frame-Options" apps/web/next.config.js && echo "✓ X-Frame-Options configured" || echo "✗ X-Frame-Options missing"
          grep -q "X-Content-Type-Options" apps/web/next.config.js && echo "✓ X-Content-Type-Options configured" || echo "✗ X-Content-Type-Options missing"
